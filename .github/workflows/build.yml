name: Build Sit Straight

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # Allow manual triggering

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Build the app
      run: |
        xcodebuild -project SitStraight.xcodeproj -scheme SitStraight -configuration Release -destination "platform=macOS,arch=arm64" build -derivedDataPath ./DerivedData-arm64
        xcodebuild -project SitStraight.xcodeproj -scheme SitStraight -configuration Release -destination "platform=macOS,arch=x86_64" build -derivedDataPath ./DerivedData-x86_64

    - name: Create universal app bundle
      run: |
        mkdir -p dist
        # Copy arm64 app as base
        cp -R DerivedData-arm64/Build/Products/Release/SitStraight.app dist/SitStraight.app
        
        # Create universal binary for the main executable
        lipo -create \
          DerivedData-arm64/Build/Products/Release/SitStraight.app/Contents/MacOS/SitStraight \
          DerivedData-x86_64/Build/Products/Release/SitStraight.app/Contents/MacOS/SitStraight \
          -output dist/SitStraight.app/Contents/MacOS/SitStraight
        
        # Remove quarantine attribute to avoid security warnings
        echo "ðŸ”“ Removing quarantine attribute..."
        xattr -d com.apple.quarantine dist/SitStraight.app 2>/dev/null || true
        
        # Verify the universal binary
        echo "Universal binary info:"
        lipo -info dist/SitStraight.app/Contents/MacOS/SitStraight
        
        # Create installation instructions
        echo "ðŸ“± Installation Instructions:"
        echo "1. Download the SitStraight.app artifact"
        echo "2. Extract the zip file"
        echo "3. Right-click SitStraight.app â†’ Open â†’ Open (to bypass security warning)"
        echo "4. Or install to Applications: sudo cp -R SitStraight.app /Applications/"

    - name: Upload built app
      uses: actions/upload-artifact@v4
      with:
        name: SitStraight.app
        path: dist/SitStraight.app
        retention-days: 30

    - name: Create release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/SitStraight.app
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
